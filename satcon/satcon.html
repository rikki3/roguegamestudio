<!DOCTYPE html>
<html lang="en">
<style>
#status-overlay {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
	height:25vh;

    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 10px;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;

    /* opacity: 1;
    visibility: visible; */

    pointer-events: auto;
    transition: opacity 0.4s ease;
}
#status-overlay button {
    pointer-events: auto;
	margin-left: 10px;
	background: rgba(255,255,255,0.1);
	color: white;
	border: 1px solid rgba(255,255,255,0.3);
	border-radius: 6px;
	padding: 4px 8px;
	cursor: pointer;
}

#status-overlay button:hover {
	background: rgba(255,255,255,0.2);
}
/* Show Overlay Button */
#show-overlay-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 10000;
	margin-top:1.55vh;

    background: rgba(0,0,0,0.7);
    color: #fff;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
}

#show-overlay-btn:hover {
    background: rgba(0,0,0,0.85);
}
</style>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ASQ v1</title>
    <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    defer
    ></script>
</head>
<body style="width: 100vw;height: 100vh;overflow: hidden; position: relative;">
	<div id="status-overlay" style="width: 100vw;height: 25%;display: none;">
		<div style="display: flex;align-items: center;width: 100%;font-size: 16px;margin-top: 24px;">
			<div id="status-text">üõ∞ Orbital search pending‚Ä¶</div>
			<button id="refresh-btn" style="display:none;">‚Üª Refresh</button>
		</div>
		<div id="coordinate-inputs" style="width:100vw; font-size: 16px;">
			<table>
				<tr>
					<td colspan="2">
						Select or search a set of coordinates below to begin:
					</td>
				</tr>
				<tr>
					<td>
						Latitude: 
					</td>
					<td>
						<input id="latInput" style="width:96px;"/>
					</td>
				</tr>
				<tr>
					<td>
						Longitude: 
					</td>
					<td>
						<input id="lngInput" style="width:96px;"/><br/>
					</td>
				</tr>
				<tr>
					<td>
						<button id="btn-SelectMapPin" style="margin-left:0vw;">üó∫Ô∏è Select</button>
					</td>
					<td>
						<button id="btn-Search">üîç Search</button>
					</td>
				</tr>
			</table>
		</div>
	</div>
    <div id="map" style="height: 103vh; width: 103vw;margin-left: -3vw;margin-top:-3vh"></div>
	<button id="show-overlay-btn" style="font-size: 18px;margin-top:24px;margin-right:0.25vw;display: none;">Close</button>
	<!-- Satellite category dropdown -->
	<select id="dropdown" style="visibility: hidden;">
		<option value="0">-- Select an option --</option>
	</select>

	<!-- Results table -->
	<table id="sat-table" cellpadding="6" cellspacing="0" style="visibility: hidden;">
		<thead>
			<tr>
				<th>Sat ID</th>
				<th>Name</th>
				<th>Altitude (km)</th>
				<th>Latitude</th>
				<th>Longitude</th>
				<th>Launch Date</th>
				<th>International Designator</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<script>
		const overlay = document.getElementById("status-overlay");
		const statusText = document.getElementById("status-text");
		const refreshBtn = document.getElementById("refresh-btn");
		const showBtn = document.getElementById("show-overlay-btn");
		const latInput = document.getElementById("latInput");
		const lngInput = document.getElementById("lngInput");
		const searchBtn = document.getElementById("btn-Search");
		const coordinatesDiv = document.getElementById("coordinate-inputs");
		const selectBtn = document.getElementById("btn-SelectMapPin");

		// Show/Hide button logic
		showBtn.addEventListener("click", () => {
			if (overlay.style.visibility === "visible") {
				overlay.style.opacity = 0;
				setTimeout(() => {
					overlay.style.visibility = "hidden";
				}, 400);
				showBtn.textContent = "Open";
			} else {
				overlay.style.visibility = "visible";
				overlay.style.opacity = 1;
				showBtn.textContent = "Close";
			}
		});

		// Search validation
		function isValidCoordinates(lat, lon) {
			return (
				typeof lat === 'number' &&
				typeof lon === 'number' &&
				lat >= -90 && lat <= 90 &&
				lon >= -180 && lon <= 180
			);
		}

		// Search button logic
		searchBtn.addEventListener("click", () => {

			try {
				const lat = parseFloat(latInput.value);
				const lon = parseFloat(lngInput.value); // Assuming you also have a longInput field

				if (isValidCoordinates(lat, lon)) {
					showStatus("üåê‚úîÔ∏èInitializing...", false, false);
					SearchLat = latInput.value;
					SearchLng = lngInput.value;
					initMap(SearchLat, SearchLng);
				} else {
					showStatus("üìå‚ùåInvalid coordinates...", false, true);
				}
			} catch (error) {
				showStatus("üåê‚ùåAn error has occurred...", true, false)
				console.error("Error: ", error.message);

			}
		});

		// Select button logic
		selectBtn.addEventListener("click", () => {

			try {
				showBtn.style.display = "none";
				showStatus("üó∫Ô∏èüìçClick on the map to select coordinates...", false, false);

				// If the map is not initialized, initialize a temporary one for selection
				if (!map) {
					map = L.map("map").setView([0, 0], 2);

					L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
						attribution: "&copy; OpenStreetMap contributors"
					}).addTo(map);
				}

				const onPick = (e) => {
					const { lat, lng } = e.latlng;

					latInput.value = lat.toFixed(6);
					lngInput.value = lng.toFixed(6);

					SearchLat = lat;
					SearchLng = lng;

					if (userMarker) {
						userMarker.setLatLng([lat, lng]);
					} else {
						userMarker = L.marker([lat, lng]).addTo(map);
					}

					map.off("click", onPick);

					map.remove();
					map = null;

					showStatus("üåê‚úîÔ∏èLocation selected!", false, true);
					searchBtn.click();
				};

				map.on("click", onPick);

			} catch (error) {
				showStatus("üåê‚ùåAn error has occurred...")
				console.error("Error: ", error.message);
			}
		});

		

		// Helper to detect Android or iPhone user agents
		function isMobile() {
			return /Android|iPhone/i.test(navigator.userAgent);
		}

		// ShowStatus function
		function showStatus(text, showRefresh=false, showCoordInputs=false) {
			// Update status text
			statusText.textContent = text;

			// Show overlay if hidden
			overlay.style.transition = "opacity 0.4s ease";
			overlay.style.visibility = "visible";
			overlay.style.opacity = 1;

			// Update show/hide button to Hide
			showBtn.textContent = "Close";

			// Show refresh button only on error
			refreshBtn.style.display = showRefresh ? "inline-block" : "none";

			// Show coordinates inputs and buttons
			coordinatesDiv.style.display = showCoordInputs ? "inline-block" : "none";
			// Apply Android-only left margin when coordinates are visible
			if (isMobile() && showCoordInputs) {
				coordinatesDiv.style.marginLeft = "-1.5vw";
			} else {
				coordinatesDiv.style.marginLeft = "";
			}
		} 

		// Refresh button logic
		refreshBtn.addEventListener("click", async () => {
			window.location.href="https://roguegamestudio.space/satcon/satcon.html"
		});

        /* =========================
		   Leaflet
		========================= */
        let map;
        let userMarker;
        let satelliteLayer;
        let satelliteIcon;
		let debrisIcon;
		let rocketBodyIcon;
		
		

        function autoLocateUser() {
            if (!("geolocation" in navigator)) {
                showStatus("üåê‚ùåGeolocation is not supported by this browser.", false, true);
                return;
            }
			showStatus("üåêüìåGrant permission to begin geolocation...");
            navigator.geolocation.getCurrentPosition(
                position => {
					showStatus("üåêüìåDetermining your location...");
                    SearchLat = position.coords.latitude;
                    SearchLng = position.coords.longitude;
					showStatus("üåê‚úîÔ∏èLocation approximated! Initializing...");
                    initMap(SearchLat, SearchLng);

                    console.log("Latitude: " + SearchLat + "\nLongitude: " + SearchLng + "\nInitializing Leaflet's map...");
                },
                error => {
					showStatus("üåê‚ùåAn error occurred while determining your location!", true, true);
					if (isMobile()) {
						refreshBtn.style.marginBottom = "-26.5vh";
						refreshBtn.style.marginRight = "2vh";
					} else {
						// Reset any Android-only margins for other platforms
						refreshBtn.style.marginBottom = "";
						refreshBtn.style.marginRight = "";
					}
                    console.error(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function initMap(lat, lng) {
            if (!map) {
                map = L.map("map").setView([lat, lng], 18);

                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "&copy; OpenStreetMap contributors"
                }).addTo(map);

                userMarker = L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup("You")
                    .openPopup();
				
				debrisIcon = L.icon({
					iconUrl: 'debris.png',
					iconSize: [96, 96],
					iconAnchor: [48, 48],
					popupAnchor: [0, -48]
				});

				rocketBodyIcon = L.icon({
					iconUrl: 'rocket_body.png',
					iconSize: [96, 96],
					iconAnchor: [48, 48],
					popupAnchor: [0, -48]
				});

				satelliteIcon = L.icon({
					iconUrl: 'satellite.png',
					iconSize: [96, 96],
					iconAnchor: [48, 48],
					popupAnchor: [0, -48]
				});

            } else {
                map.setView([lat, lng], 13);
                userMarker.setLatLng([lat, lng]);
            }
			userMarker.setPopupContent("")
            fetchSatellites();
        }

		function getIconSizeByAltitude(alt) {
			const minSize = 48;
			const maxSize = 96;
			const minAlt = 160;   // km enters low earth orbit
			const maxAlt = 12800;  // km exists low earth orbit
			const size = Math.max(minSize, Math.min(maxSize, maxSize - ((alt - minAlt) / (maxAlt - minAlt)) * (maxSize - minSize)));
			return [size, size];
		}

        function plotSatellitesOnMap(satellites) {
			if (!map) return;

			if (satelliteLayer) map.removeLayer(satelliteLayer);
			satelliteLayer = L.layerGroup();

			const bounds = [];
			satellites.forEach(sat => {
				if (typeof sat.satlat !== "number" || typeof sat.satlng !== "number") return;

				
				const iconSize = getIconSizeByAltitude(sat.satalt);
				const iconToUse = L.icon({
					iconUrl: sat.satname?.includes("DEB") ? 'debris.png' : sat.satname?.includes("R/B") ? 'rocket_body.png' : 'satellite.png',
					iconSize: iconSize,
					iconAnchor: [iconSize[0] / 2, iconSize[1] / 2],
					popupAnchor: [0, -iconSize[1] / 2]
				});

				const marker = L.marker([sat.satlat, sat.satlng], { icon: iconToUse })
					.bindPopup(`
						<strong>${sat.satname?.includes("DEB") ? "DEBRIS:" : sat.satname?.includes("R/B") ? "ROCKET BODY:" : "SATELLITE:"}</strong><br>
						<strong>${sat.satname?.includes("DEB") ? sat.satname.replace("DEB", "") : sat.satname?.includes("R/B") ? sat.satname.replace("R/B", "") : sat.satname}</strong><br>
						Latitude:${sat.satlat}<br>
						Longitude:${sat.satlng}<br>
						Altitude: ${sat.satalt.toFixed(1)} km<br><br>
						ID: ${sat.satid}<br>
						Launch Date: ${sat.launchDate}
					`, { autoPan: true, autoPanPadding: [130, 130] });

				satelliteLayer.addLayer(marker);
				bounds.push([sat.satlat, sat.satlng]);
			});

			satelliteLayer.addTo(map);
			if (userMarker) bounds.push(userMarker.getLatLng());
			if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });

			
			// if (SearchLat == -33.915221 && SearchLng == 18.404708)
			// {
			// 	showStatus("üåå‚úîÔ∏èQueried Signal Hill's aerospace for detected objects orbiting earth.");
			// 	return
			// }
		}

		let SearchLat = 0;
		let SearchLng = 0;

		const dropdown = document.getElementById("dropdown");

		const categories = new Map([
			[1, "Brightest"], [2, "ISS"], [3, "Weather"], [4, "NOAA"], [5, "GOES"],
			[6, "Earth resources"], [7, "Search & rescue"], [8, "Disaster monitoring"],
			[9, "Tracking and Data Relay Satellite System"], [10, "Geostationary"],
			[11, "Intelsat"], [12, "Gorizont"], [13, "Raduga"], [14, "Molniya"],
			[15, "Iridium"], [16, "Orbcomm"], [17, "Globalstar"], [18, "Amateur radio"],
			[19, "Experimental"], [20, "Global Positioning System (GPS) Operational"],
			[21, "Glonass Operational"], [22, "Galileo"], [23, "Satellite-Based Augmentation System"],
			[24, "Navy Navigation Satellite System"], [25, "Russian LEO Navigation"], [26, "Space & Earth Science"],
			[27, "Geodetic"], [28, "Engineering"], [29, "Education"], [30, "Military"], [31, "Radar Calibration"],
			[32, "CubeSats"], [33, "XM and Sirius"], [34, "TV"], [35, "Beidou Navigation System"], [36, "Yaogan"],
			[37, "Westford Needles"], [38, "Parus"], [39, "Strela"], [40, "Gonets"], [41, "Tsiklon"], [42, "Tsikada"],
			[43, "O3B Networks"], [44, "Tselina"], [45, "Celestis"], [46, "IRNSS"], [47, "QZSS"], [48, "Flock"],
			[49, "Lemur"], [50, "Global Positioning System (GPS) Constellation"], [51, "Glonass Constellation"], 
			[52, "Starlink"], [53, "OneWeb"], [54, "Chinese Space Station"], [55, "Qianfan"], [56, "Kuiper"], [57, "GeeSAT"]
		]);

		function populateCategories() {
			categories.forEach((text, value) => {
				const option = document.createElement("option");
				option.value = value;
				option.textContent = text;
				dropdown.appendChild(option);
			});

			dropdown.addEventListener("change", e => {
                const selectedCategory = e.target.value;
                if (!selectedCategory || SearchLat === 0 || SearchLng === 0) return;
                fetchSatellites();
            });
		}

        window.addEventListener("load", () => {
            populateCategories();
			latInput.value = "";
			lngInput.value = "";
			if (isMobile()) {
				overlay.style.height = "25%";
				showBtn.style.marginTop = "18.5px";
			} else {
				overlay.style.height = "18%";
			}
			if (confirm("Search Earth's orbit near you?")) {
				autoLocateUser();
			}
			overlay.style.display = "";
			showBtn.style.display = "";
        });

		function prepareRenderTable() {
			const tbody = document.querySelector("#sat-table tbody");
			tbody.innerHTML = "";

			const row = document.createElement("tr");
			const cell = document.createElement("td");
			cell.colSpan = 7;
			cell.textContent = "Searching for satellites...";
			
			row.appendChild(cell);
			tbody.appendChild(row);
		}

		function renderTable(satellites) {
			const tbody = document.querySelector("#sat-table tbody");
			tbody.innerHTML = "";
			if (!satellites || satellites.length === 0) {
				const row = document.createElement("tr");
				const cell = document.createElement("td");
				cell.colSpan = 7;
				cell.textContent = "No satellites found.";
				row.appendChild(cell);
				tbody.appendChild(row);
				return;
			}
			satellites.forEach(sat => {
				const row = document.createElement("tr");
				row.innerHTML = `
					<td>${sat.satid}</td>
					<td>${sat.satname}</td>
					<td>${sat.satalt}</td>
					<td>${sat.satlat}</td>
					<td>${sat.satlng}</td>
					<td>${sat.launchDate}</td>
					<td>${sat.intDesignator}</td>
				`;
				tbody.appendChild(row);
			});
		}

		
		async function fetchSatellites() {
			showStatus("üì°üåêSearching for objects orbiting Earth within 10¬∫ of the coordinates...");
			showBtn.style.display = "none";
            prepareRenderTable();
			//if (SearchLat == 0 || SearchLng == 0) { SearchLat = -33.915221; SearchLng = 18.404708; userMarker?.setPopupContent("Signal Hill"); }
            const url = `https://roguegamestudio-api.rickeshsingh0.workers.dev/?lat=${SearchLat}&lng=${SearchLng}&cat=0`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
				const orbitingObjects = data.info.satcount
				if (orbitingObjects == 0) {
					showStatus("‚ùåüìåNo objects detected orbiting Earth within 10¬∫ of the coordinates.", true, true);
					return;
				}
				showStatus("üì°‚úîÔ∏èSuccessfully queried Earth's orbit! Please wait...");
                renderTable(data.above);
                plotSatellitesOnMap(data.above);

				let satellitesCount = 0;
				let debrisCount = 0;
				let rocketBodyCount = 0;

				data.above.forEach(sat => {
					if (!sat.satname) return;
					if (sat.satname.includes("DEB")) debrisCount++;
					else if (sat.satname.includes("R/B")) rocketBodyCount++;
					else satellitesCount++;
				});

				const totalObjects = satellitesCount + debrisCount + rocketBodyCount;

				if (orbitingObjects == 1) {
					let typeLine = "";
					if (satellitesCount === 1) typeLine = "Satellite: x1";
					else if (debrisCount === 1) typeLine = "Debris: x1";
					else if (rocketBodyCount === 1) typeLine = "Rocket Body: x1";
					showStatus("", true);
					document.getElementById("status-text").innerHTML = "üåå‚úîÔ∏èOnly " + data.above.first.satname + " has been detected orbiting Earth within the 10¬∫ search radius.<br/>" + typeLine;
					if (isMobile()) {
						refreshBtn.style.marginTop = "-3vh";
						refreshBtn.style.marginRight = "1.85vh";
					}
					else {
						refreshBtn.style.marginTop = "-6vh";
					}
				} 
				else if (orbitingObjects == 2) {
					showStatus("", true);
					document.getElementById("status-text").innerHTML = "üåå‚úîÔ∏èA total of " + orbitingObjects + " objects orbiting Earth were detected within the 10¬∫ search radius.<br/>Satellites: x" + satellitesCount + "<br/>Debris: x" + debrisCount + "<br/>Rocket Bodies: x" + rocketBodyCount;
					if (isMobile()) {
						refreshBtn.style.marginTop = "-3vh";
						refreshBtn.style.marginRight = "1.85vh";
					}
					else {
						refreshBtn.style.marginTop = "-6vh";
					}
				} 
				else if (orbitingObjects >= 3) {
					showStatus("", true);
					document.getElementById("status-text").innerHTML = "üåå‚úîÔ∏èA total of " + orbitingObjects + " objects orbiting Earth were detected within the 10¬∫ search radius!<br/>Satellites: x" + satellitesCount + "<br/>Debris: x" + debrisCount + "<br/>Rocket Bodies: x" + rocketBodyCount;
					if (isMobile()) {
						refreshBtn.style.marginTop = "-3vh";
						refreshBtn.style.marginRight = "1.85vh";
					}
					else {
						refreshBtn.style.marginTop = "-6vh";
					}
				}
				showBtn.style.display = ""; 
            } catch (error) {
				showBtn.style.display = "";
				showStatus("‚ùåüòÖSomething strange has gone wrong!üß≠‚è∞", true);
                console.error("An error occurred during the fetchSatellites() function: ", error);
            }
        }
	</script>

</body>
</html>
