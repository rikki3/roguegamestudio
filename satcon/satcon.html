<!DOCTYPE html>
<html lang="en">
<style>
#status-overlay {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
	height:5vh;

    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 14px;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;

    opacity: 1;
    visibility: visible;

    pointer-events: auto;
    transition: opacity 0.4s ease;
}
#status-overlay button {
    pointer-events: auto;
	margin-left: 10px;
	background: rgba(255,255,255,0.1);
	color: white;
	border: 1px solid rgba(255,255,255,0.3);
	border-radius: 6px;
	padding: 4px 8px;
	cursor: pointer;
}

#status-overlay button:hover {
	background: rgba(255,255,255,0.2);
}
/* Show Overlay Button */
#show-overlay-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 10000;
	margin-top:1.55vh;

    background: rgba(0,0,0,0.7);
    color: #fff;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
}

#show-overlay-btn:hover {
    background: rgba(0,0,0,0.85);
}
</style>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ASQ v1</title>
    <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    defer
    ></script>
</head>
<body style="width: 100vw;height: 100vh;overflow: hidden; position: relative;">
	<div style="display: flex;align-items: center;width: 100%;font-size: 24px;" id="status-overlay">
		<span id="status-text">ğŸ›° Searching satellitesâ€¦</span>
		<button id="refresh-btn" style="display:none;">â†» Refresh</button>
	</div>
    <div id="map" style="height: 103vh; width: 103vw;margin-left: -3vw;margin-top:-3vh"></div>
	<button id="show-overlay-btn" style="font-size: 21px;margin-top:2.25vh;">Hide</button>
	<!-- Satellite category dropdown -->
	<select id="dropdown" style="visibility: hidden;">
		<option value="0">-- Select an option --</option>
	</select>

	<!-- Results table -->
	<table id="sat-table" cellpadding="6" cellspacing="0" style="visibility: hidden;">
		<thead>
			<tr>
				<th>Sat ID</th>
				<th>Name</th>
				<th>Altitude (km)</th>
				<th>Latitude</th>
				<th>Longitude</th>
				<th>Launch Date</th>
				<th>International Designator</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<script>
		const overlay = document.getElementById("status-overlay");
		const statusText = document.getElementById("status-text");
		const refreshBtn = document.getElementById("refresh-btn");
		const showBtn = document.getElementById("show-overlay-btn");

		// Show/Hide button logic
		showBtn.addEventListener("click", () => {
			if (overlay.style.visibility === "visible") {
				overlay.style.opacity = 0;
				setTimeout(() => {
					overlay.style.visibility = "hidden";
				}, 400);
				showBtn.textContent = "Status";
			} else {
				overlay.style.visibility = "visible";
				overlay.style.opacity = 1;
				showBtn.textContent = "Close";
			}
		});

		

		// ShowStatus function
		function showStatus(text, isError=false) {
			// Update status text
			statusText.textContent = text;

			// Show overlay if hidden
			overlay.style.transition = "opacity 0.4s ease";
			overlay.style.visibility = "visible";
			overlay.style.opacity = 1;

			// Update show/hide button to Hide
			showBtn.textContent = "Close";

			// Show refresh button only on error
			refreshBtn.style.display = isError ? "inline-block" : "none";
		}

		// Refresh button logic
		refreshBtn.addEventListener("click", async () => {
			localStorage.clear();
			sessionStorage.clear();
			if (window.indexedDB) {
				const dbs = await indexedDB.databases();
				dbs.forEach(db => indexedDB.deleteDatabase(db.name));
			}
			if ("serviceWorker" in navigator) {
				const regs = await navigator.serviceWorker.getRegistrations();
				for (const reg of regs) await reg.unregister();
			}
			const url = new URL(window.location.href);
			url.searchParams.set("_fresh", Date.now());
			window.location.replace(url.toString());
		});

        /* =========================
		   Leaflet
		========================= */
        let map;
        let userMarker;
        let satelliteLayer;
        let satelliteIcon;

        function autoLocateUser() {
            if (!("geolocation" in navigator)) {
                showStatus("ğŸŒâŒGeolocation not supported by this browser.", true);
                return;
            }
			showStatus("ğŸŒğŸ“ŒProvide permission to initiate geolocation...");
            navigator.geolocation.getCurrentPosition(
                position => {
					showStatus("ğŸŒğŸ“ŒGeolocating...");
                    SearchLat = position.coords.latitude;
                    SearchLng = position.coords.longitude;
                    console.log("Latitude: " + SearchLat + "\nLongitude: " + SearchLng + "\nInitializing Leaflet's map...");
                    initMap(SearchLat, SearchLng);
                },
                error => {
					showStatus("âŒGeolocation error encounteredâš ï¸Initializing default location...ğŸŒ„Awaiting Signal Hill, Cape Town, 8001 response...", true);
                    console.error(error);
					initMap(-33.915221, 18.404708);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function initMap(lat, lng) {
            if (!map) {
                map = L.map("map").setView([lat, lng], 18);

                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "&copy; OpenStreetMap contributors"
                }).addTo(map);

                userMarker = L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup("Your location")
                    .openPopup();

				satelliteIcon = L.icon({
					iconUrl: 'satellite.png',
					iconSize: [128, 128],
					iconAnchor: [64, 64],
					popupAnchor: [0, -64]
				});
            } else {
                map.setView([lat, lng], 13);
                userMarker.setLatLng([lat, lng]);
            }
			userMarker.setPopupContent("ğŸ“ŒYou are here!")
            fetchSatellites();
        }

        function plotSatellitesOnMap(satellites) {
			if (!map) return;

			if (satelliteLayer) map.removeLayer(satelliteLayer);
			satelliteLayer = L.layerGroup();

			const bounds = [];
			satellites.forEach(sat => {
				if (typeof sat.satlat !== "number" || typeof sat.satlng !== "number") return;

				const marker = L.marker([sat.satlat, sat.satlng], { icon: satelliteIcon })
					.bindPopup(`
						<strong>${sat.satname}</strong><br>
						Latitude:${sat.satlat}<br>
						Longitude:${sat.satlng}<br>
						Altitude: ${sat.satalt.toFixed(1)} km<br><br>
						ID: ${sat.satid}<br>
						Launch Date: ${sat.launchDate}<br><br>
						Country of Origin: (Pending)<br>
						Purpose: (Pending)<br>
					`, { autoPan: true, autoPanPadding: [175, 175] });

				satelliteLayer.addLayer(marker);
				bounds.push([sat.satlat, sat.satlng]);
			});

			satelliteLayer.addTo(map);
			if (userMarker) bounds.push(userMarker.getLatLng());
			if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });

			
			if (SearchLat == -33.915221 && SearchLng == 18.404708)
			{
				showStatus("ğŸŒŒâœ”ï¸Successfully queried Signal Hill's aerospace for detected objects orbiting earth.");
				return
			}
			showStatus("ğŸŒŒâœ”ï¸Successfully queried your coordinate's aerospace for detected objects orbiting earth.");
		}

		let SearchLat = 0;
		let SearchLng = 0;

		const dropdown = document.getElementById("dropdown");

		const categories = new Map([
			[1, "Brightest"], [2, "ISS"], [3, "Weather"], [4, "NOAA"], [5, "GOES"],
			[6, "Earth resources"], [7, "Search & rescue"], [8, "Disaster monitoring"],
			[9, "Tracking and Data Relay Satellite System"], [10, "Geostationary"],
			[11, "Intelsat"], [12, "Gorizont"], [13, "Raduga"], [14, "Molniya"],
			[15, "Iridium"], [16, "Orbcomm"], [17, "Globalstar"], [18, "Amateur radio"],
			[19, "Experimental"], [20, "Global Positioning System (GPS) Operational"],
			[21, "Glonass Operational"], [22, "Galileo"], [23, "Satellite-Based Augmentation System"],
			[24, "Navy Navigation Satellite System"], [25, "Russian LEO Navigation"], [26, "Space & Earth Science"],
			[27, "Geodetic"], [28, "Engineering"], [29, "Education"], [30, "Military"], [31, "Radar Calibration"],
			[32, "CubeSats"], [33, "XM and Sirius"], [34, "TV"], [35, "Beidou Navigation System"], [36, "Yaogan"],
			[37, "Westford Needles"], [38, "Parus"], [39, "Strela"], [40, "Gonets"], [41, "Tsiklon"], [42, "Tsikada"],
			[43, "O3B Networks"], [44, "Tselina"], [45, "Celestis"], [46, "IRNSS"], [47, "QZSS"], [48, "Flock"],
			[49, "Lemur"], [50, "Global Positioning System (GPS) Constellation"], [51, "Glonass Constellation"], 
			[52, "Starlink"], [53, "OneWeb"], [54, "Chinese Space Station"], [55, "Qianfan"], [56, "Kuiper"], [57, "GeeSAT"]
		]);

		function populateCategories() {
			categories.forEach((text, value) => {
				const option = document.createElement("option");
				option.value = value;
				option.textContent = text;
				dropdown.appendChild(option);
			});

			dropdown.addEventListener("change", e => {
                const selectedCategory = e.target.value;
                if (!selectedCategory || SearchLat === 0 || SearchLng === 0) return;
                fetchSatellites();
            });
		}

        window.addEventListener("load", () => {
            populateCategories();
            autoLocateUser();
        });

		function prepareRenderTable() {
			const tbody = document.querySelector("#sat-table tbody");
			tbody.innerHTML = "";

			const row = document.createElement("tr");
			const cell = document.createElement("td");
			cell.colSpan = 7;
			cell.textContent = "Searching your aerospace for satellites...";
			row.appendChild(cell);
			tbody.appendChild(row);
		}

		function renderTable(satellites) {
			const tbody = document.querySelector("#sat-table tbody");
			tbody.innerHTML = "";
			if (!satellites || satellites.length === 0) {
				const row = document.createElement("tr");
				const cell = document.createElement("td");
				cell.colSpan = 7;
				cell.textContent = "No satellites found.";
				row.appendChild(cell);
				tbody.appendChild(row);
				return;
			}
			satellites.forEach(sat => {
				const row = document.createElement("tr");
				row.innerHTML = `
					<td>${sat.satid}</td>
					<td>${sat.satname}</td>
					<td>${sat.satalt}</td>
					<td>${sat.satlat}</td>
					<td>${sat.satlng}</td>
					<td>${sat.launchDate}</td>
					<td>${sat.intDesignator}</td>
				`;
				tbody.appendChild(row);
			});
		}

		
		async function fetchSatellites() {
            prepareRenderTable();
			if (SearchLat == 0 || SearchLng == 0) { SearchLat = -33.915221; SearchLng = 18.404708; userMarker?.setPopupContent("ğŸŒ„Signal Hill"); }
            const url = `https://roguegamestudio-api.rickeshsingh0.workers.dev/?lat=${SearchLat}&lng=${SearchLng}&cat=0`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
				if (data.info.satcount == 0) {
					showStatus("âŒğŸ“ŒNo objects detected orbiting Earth within 10Âº of the queried coordinate's aerospace...", true);
					return;
				}
				showStatus("ğŸ“¡âœ”ï¸Objects detected orbiting Earth within 10Âº of the queried coordinate's aerospace.");
                renderTable(data.above);
                plotSatellitesOnMap(data.above);
            } catch (error) {
				showStatus("âŒğŸ˜… Something strange has gone wrong! ğŸ§­â°", true);
                console.error("An error occurred during the fetchSatellites() function: ", error);
            }
        }
	</script>

</body>
</html>
